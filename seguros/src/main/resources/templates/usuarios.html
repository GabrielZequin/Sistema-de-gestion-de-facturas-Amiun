<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Usuarios</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        /* Base compacta para pantallas admin */
        body { background: #f6f7fb; }
        .page-wrap { padding-bottom: 24px; }

        .page-title {
            font-weight: 700;
            letter-spacing: -.02em;
            color: #0f172a;
        }
        .page-subtitle { color: #64748b; font-size: 13px; }

        .card-soft {
            border: 0;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
        }

        .table thead th { white-space: nowrap; }
        .table td, .table th { vertical-align: middle; }

        /* Tabla más moderna */
        .table-modern {
            border-color: #e6eaf2;
        }
        .table-modern thead th {
            background: #0f172a;
            color: #fff;
            border-color: rgba(255,255,255,.08);
        }

        /* Acciones compactas */
        .actions {
            display: flex;
            gap: .4rem;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .btn { border-radius: 12px; }
        .btn-sm { padding: .2rem .55rem; font-size: 12px; }

        /* Chips / badges */
        .badge-role { font-size: 11px; padding: .35em .55em; border-radius: 999px; }

        /* Header de la card con separación */
        .card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid #e6eaf2;
        }
        .card-head .hint { font-size: 12px; color: #64748b; }

        /* Alertas más finas */
        .alert { border-radius: 14px; }
    </style>
</head>

<body class="bg-light">

<div th:replace="fragments/navbar :: navbar"></div>

<div class="container page-wrap">

    <!-- Encabezado -->
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
        <div>
            <div class="page-title h4 mb-0">Usuarios</div>
            <div class="page-subtitle">Gestión de accesos al sistema</div>
        </div>

        <a class="btn btn-primary btn-sm px-3"
           th:href="@{/usuarios/nuevo}">
            + Nuevo usuario
        </a>
    </div>

    <!-- Mensajes -->
    <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show py-2">
        <span th:text="${mensaje}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show py-2">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Card tabla -->
    <div class="card card-soft">
        <div class="card-head">
            <div class="hint">Listado de usuarios registrados</div>
            <div class="hint" th:if="${usuarios != null}">
                Total: <b th:text="${#lists.size(usuarios)}"></b>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-modern table-hover align-middle mb-0">
                    <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>Username</th>
                        <th style="width: 140px;">Rol</th>
                        <th>Sucursal</th>
                        <th style="width: 320px;">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>

                    <tr th:if="${#lists.isEmpty(usuarios)}">
                        <td colspan="5" class="text-center text-muted py-4">
                            No hay usuarios.
                        </td>
                    </tr>

                    <tr th:each="u : ${usuarios}">
                        <td th:text="${u.id}"></td>

                        <td>
                            <div class="fw-semibold" th:text="${u.username}"></div>
                            <div class="text-muted" style="font-size:12px;" th:text="${u.sucursal != null ? 'Sucursal: ' + u.sucursal : ''}"></div>
                        </td>

                        <td>
                            <span th:if="${u.rol == 'ADMIN'}" class="badge badge-role text-bg-primary">ADMIN</span>
                            <span th:if="${u.rol != 'ADMIN'}" class="badge badge-role text-bg-secondary" th:text="${u.rol}">PDV</span>
                        </td>

                        <td th:text="${u.sucursal != null ? u.sucursal : '—'}"></td>

                        <td>
                            <div class="actions">

                                <a class="btn btn-sm btn-outline-primary"
                                   th:href="@{'/usuarios/' + ${u.id} + '/editar'}">
                                    Editar
                                </a>

                                <form th:action="@{'/usuarios/' + ${u.id} + '/reset-password'}"
                                      method="post"
                                      class="mb-0">
                                    <button class="btn btn-sm btn-outline-warning"
                                            type="submit"
                                            onclick="return confirm('¿Resetear contraseña a 1234?');">
                                        Reset 1234
                                    </button>
                                </form>

                                <form th:action="@{'/usuarios/' + ${u.id} + '/eliminar'}"
                                      method="post"
                                      class="mb-0"
                                      onsubmit="return confirm('¿Eliminar usuario?');">
                                    <button class="btn btn-sm btn-outline-danger" type="submit">
                                        Eliminar
                                    </button>
                                </form>

                            </div>
                        </td>
                    </tr>

                    </tbody>
                </table>
            </div>
        </div>

        <div class="p-3 pt-2 text-muted" style="font-size:12px;">
            Tip: el botón <b>Reset 1234</b> restablece la clave del usuario a una contraseña inicial.
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
